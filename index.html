<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>í–‰ë³µë„¤ì»· (V3.11)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Jua&family=Noto+Sans+KR:wght@400;700&family=Nanum+Pen+Script&family=Nanum+Gothic:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            overscroll-behavior: none;
            touch-action: none; 
            user-select: none;
            -webkit-user-select: none;
        }
        h1, h2, h3, .font-jua { font-family: 'Jua', sans-serif; }
        .font-pen { font-family: 'Nanum Pen Script', cursive; }
        .font-gothic { font-family: 'Nanum Gothic', sans-serif; }

        .photo-card.selected {
            border: 4px solid #ec4899;
            transform: scale(0.95);
        }
        .photo-number {
            position: absolute; top: 6px; right: 6px;
            background: #ec4899; color: white;
            width: 26px; height: 26px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 14px; z-index: 10;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        @keyframes flash {
            0% { opacity: 1; }
            50% { opacity: 0; background: white; }
            100% { opacity: 1; }
        }
        .flash-effect { animation: flash 0.2s; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .color-dot {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .color-dot.active { border-color: #ec4899; transform: scale(1.15); box-shadow: 0 0 8px rgba(236, 72, 153, 0.4); }

        .preview-container {
            width: 100%;
            height: 100%;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .canvas-wrapper {
            position: relative;
            height: 100%;
            aspect-ratio: 2 / 6;
            background: white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .layer-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: block;
        }

        .sticker-item {
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #fdf2f8;
            border-radius: 50%;
            cursor: pointer;
            width: 44px;
            height: 44px;
            transition: all 0.1s;
            border: 2px solid transparent;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .sticker-item:active { transform: scale(0.9); background: #fce7f3; border-color: #f472b6; }

        .font-selector {
            padding: 8px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            font-size: 14px;
            cursor: pointer;
        }
    </style>
</head>
<body class="h-[100dvh] w-full bg-gray-100 flex justify-center items-center overflow-hidden text-gray-800">

    <div class="w-full h-full max-w-[500px] bg-white flex flex-col shadow-2xl relative overflow-hidden">

        <!-- Header -->
        <header class="bg-white p-3 shadow-sm flex justify-center items-center z-10 shrink-0 h-14 border-b">
            <div class="flex items-center gap-2">
                <i data-lucide="camera" class="text-pink-500 w-6 h-6"></i>
                <h1 class="text-xl font-jua text-pink-600">í–‰ë³µë„¤ì»· <span class="text-xs text-gray-400 font-normal">V3.11</span></h1>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-1 relative w-full flex flex-col items-center overflow-hidden bg-gray-50">
            
            <!-- 1ï¸âƒ£ Start Screen -->
            <section id="step-start" class="text-center w-full h-full flex flex-col p-6 overflow-y-auto hide-scrollbar">
                <div class="flex-1 flex flex-col justify-center items-center py-4">
                    <div class="bg-white p-10 rounded-[2.5rem] shadow-xl border-[6px] border-pink-100 w-full max-w-[380px] flex flex-col items-center gap-8">
                        <div class="flex flex-col items-center gap-4">
                            <div class="w-24 h-24 bg-pink-50 rounded-full flex items-center justify-center mb-2 shadow-inner">
                                <i data-lucide="camera" class="w-14 h-14 text-pink-500"></i>
                            </div>
                            <h2 class="text-3xl font-jua text-pink-600">ì¶”ì–µì„ ì°ì–´ìš”!</h2>
                            <p class="text-lg text-gray-600 font-medium leading-relaxed">
                                í–‰ë³µí•œ ìˆœê°„ì„ ê¸°ë¡í•˜ê³ <br>
                                ìŠ¤í‹°ì»¤ì™€ ë¬¸êµ¬ë¡œ ê¾¸ë©°ë³´ì„¸ìš”
                            </p>
                        </div>
                        <div class="grid grid-cols-4 gap-4 w-full pt-6 border-t border-pink-50">
                             <div class="flex flex-col items-center"><div class="w-10 h-10 bg-pink-50 rounded-xl flex items-center justify-center text-pink-500 mb-1"><i data-lucide="aperture" class="w-5 h-5"></i></div><span class="text-[10px] font-jua text-gray-500">ì´¬ì˜</span></div>
                             <div class="flex flex-col items-center"><div class="w-10 h-10 bg-blue-50 rounded-xl flex items-center justify-center text-blue-500 mb-1"><i data-lucide="check-square" class="w-5 h-5"></i></div><span class="text-[10px] font-jua text-gray-500">ì„ íƒ</span></div>
                             <div class="flex flex-col items-center"><div class="w-10 h-10 bg-purple-50 rounded-xl flex items-center justify-center text-purple-500 mb-1"><i data-lucide="palette" class="w-5 h-5"></i></div><span class="text-[10px] font-jua text-gray-500">í”„ë ˆì„</span></div>
                             <div class="flex flex-col items-center"><div class="w-10 h-10 bg-green-50 rounded-xl flex items-center justify-center text-green-500 mb-1"><i data-lucide="smile" class="w-5 h-5"></i></div><span class="text-[10px] font-jua text-gray-500">ê¾¸ë¯¸ê¸°</span></div>
                        </div>
                    </div>
                </div>

                <div class="flex flex-col items-center gap-6 mb-8 mt-4">
                    <div class="flex items-center bg-white px-6 py-4 rounded-full shadow-sm border border-gray-100 gap-4">
                        <span class="font-jua text-gray-700 text-xl">ì´¬ì˜ìŒ</span>
                        <div class="flex items-center gap-3">
                            <span id="label-off-ext" class="text-sm font-bold text-gray-400 transition-colors">OFF</span>
                            <div class="relative w-14 h-7 rounded-full bg-pink-500 transition-all flex items-center px-1 cursor-pointer" id="toggle-bg" onclick="toggleSound()">
                                <div id="toggle-circle" class="relative z-10 bg-white w-5 h-5 rounded-full shadow-md transform translate-x-7 transition-transform flex items-center justify-center">
                                    <i data-lucide="volume-2" id="sound-icon" class="w-3 h-3 text-pink-600"></i>
                                </div>
                            </div>
                            <span id="label-on-ext" class="text-sm font-bold text-pink-500 transition-colors">ON</span>
                        </div>
                    </div>
                    <button id="btn-start-camera" onclick="startCamera()" class="w-[240px] h-[70px] bg-pink-500 text-white font-jua text-2xl rounded-[1.8rem] shadow-lg flex items-center justify-center gap-2 hover:bg-pink-600 transition active:scale-95 border-b-4 border-pink-700">
                        <i data-lucide="camera" class="w-7 h-7"></i> ì´¬ì˜ ì‹œì‘
                    </button>
                </div>
            </section>

            <!-- 2ï¸âƒ£ Camera Screen -->
            <section id="step-camera" class="hidden flex flex-col items-center w-full h-full p-4">
                <div id="camera-container" class="relative w-full aspect-[3/4] bg-black rounded-2xl overflow-hidden shadow-xl mb-6 flex items-center justify-center border-4 border-white">
                    <video id="video-feed" autoplay playsinline class="absolute inset-0 w-full h-full object-cover transform scale-x-[-1]"></video>
                    <div id="countdown-overlay" class="absolute inset-0 flex items-center justify-center bg-black/30 hidden z-20">
                        <span id="countdown-text" class="text-8xl font-bold text-white font-jua">3</span>
                    </div>
                    <div class="absolute top-4 right-4 bg-black/50 text-white px-4 py-2 rounded-full font-mono text-xl z-10">
                        <span id="shot-count">0</span> / 6
                    </div>
                </div>
                <button onclick="stopCameraAndGoHome()" class="w-full max-w-xs bg-gray-400 text-white py-5 rounded-xl font-jua text-2xl shadow active:scale-95 transition">ì´¬ì˜ ì·¨ì†Œ</button>
                <canvas id="capture-canvas" class="hidden"></canvas>
            </section>

            <!-- 3ï¸âƒ£ Select Screen -->
            <section id="step-select" class="hidden flex flex-col items-center w-full h-full p-6 overflow-hidden">
                <div class="shrink-0 mb-6 text-center">
                    <h2 class="text-2xl font-jua text-pink-600">4ì¥ì„ ì„ íƒí•˜ì„¸ìš”!</h2>
                    <p class="text-gray-500 font-medium mt-1 text-base">(<span id="selected-count" class="text-pink-500">0</span> / 4)</p>
                </div>
                <!-- ìˆ˜ì •: px-12 -> px-20ìœ¼ë¡œ ì—¬ë°±ì„ ë” ëŠ˜ë ¤ ì‚¬ì§„ í¬ê¸°ë¥¼ ì¤„ì´ê³ , gap-4 -> gap-2ë¡œ ê°„ê²© ì¶•ì†Œ -->
                <div id="photo-grid" class="grid grid-cols-2 gap-2 w-full overflow-y-auto flex-1 hide-scrollbar mb-4 px-20 content-center"></div>
                <div class="w-full flex gap-4 h-16 shrink-0">
                    <button onclick="restartCamera()" class="flex-1 bg-gray-400 text-white font-jua text-xl rounded-2xl shadow-md active:scale-95 transition">ì¬ì´¬ì˜</button>
                    <button id="btn-confirm-select" onclick="goToFrameStep()" disabled class="flex-[2] bg-gray-300 text-white font-jua text-2xl rounded-2xl shadow-md active:scale-95 transition">ì„ íƒ ì™„ë£Œ</button>
                </div>
            </section>

            <!-- 4ï¸âƒ£ Decorate Step 1: Frame Color -->
            <section id="step-decorate-frame" class="hidden flex flex-col items-center w-full h-full p-4 overflow-hidden">
                <div class="flex-1 w-full flex overflow-hidden gap-4 mb-4">
                    <div class="flex-1 bg-white rounded-2xl p-4 shadow-md border border-gray-100 flex flex-col">
                        <h3 class="text-lg font-jua text-pink-500 mb-2 text-center border-b pb-3">í”„ë ˆì„ ìƒ‰ìƒ</h3>
                        <div id="color-dots-grid" class="flex-1 overflow-y-auto hide-scrollbar grid grid-cols-3 gap-y-4 gap-x-1 py-4 content-start justify-items-center"></div>
                    </div>
                    <div class="flex-1 flex items-center justify-center bg-gray-200/40 rounded-2xl border-2 border-dashed border-gray-200 overflow-hidden p-3">
                        <div class="preview-container">
                            <div class="canvas-wrapper">
                                <canvas id="editor-canvas" class="layer-canvas"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="w-full flex gap-3 shrink-0 h-16">
                    <button onclick="showStep('step-select')" class="flex-1 bg-gray-200 text-gray-600 font-jua text-xl rounded-xl shadow transition">ì´ì „</button>
                    <button onclick="goToStickerStep()" class="flex-[2] bg-pink-500 text-white font-jua text-2xl rounded-xl shadow transition">ìŠ¤í‹°ì»¤ ê¾¸ë¯¸ê¸°</button>
                </div>
            </section>

            <!-- 5ï¸âƒ£ Decorate Step 2: Stickers -->
            <section id="step-decorate-sticker" class="hidden flex flex-col items-center w-full h-full p-4 overflow-hidden">
                <div class="flex-1 w-full flex overflow-hidden gap-4 mb-4">
                    <div class="flex-1 bg-white rounded-2xl p-4 shadow-md border border-gray-100 flex flex-col">
                        <h3 class="text-lg font-jua text-pink-500 mb-2 text-center border-b pb-3 shrink-0">ìŠ¤í‹°ì»¤ ì„ íƒ</h3>
                        <div id="sticker-grid" class="flex-1 overflow-y-auto hide-scrollbar grid grid-cols-3 gap-y-4 gap-x-2 py-4 content-start justify-items-center"></div>
                    </div>
                    <div class="flex-1 flex items-center justify-center bg-gray-200/40 rounded-2xl border-2 border-dashed border-gray-200 overflow-hidden p-3 relative">
                        <div class="preview-container">
                            <div class="canvas-wrapper">
                                <canvas id="bg-canvas-sticker" class="layer-canvas"></canvas>
                                <canvas id="sticker-canvas" class="layer-canvas"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="w-full flex gap-3 shrink-0 h-16">
                    <button onclick="showStep('step-decorate-frame')" class="flex-1 bg-gray-200 text-gray-600 font-jua text-xl rounded-xl shadow transition">ì´ì „</button>
                    <button onclick="goToTextStep()" class="flex-[2] bg-pink-500 text-white font-jua text-2xl rounded-xl shadow transition">ë¬¸êµ¬ ì¶”ê°€í•˜ê¸°</button>
                </div>
            </section>

            <!-- 6ï¸âƒ£ Decorate Step 3: Text -->
            <section id="step-decorate-text" class="hidden flex flex-col items-center w-full h-full p-4 overflow-hidden">
                <div class="flex-1 w-full flex overflow-hidden gap-4 mb-4">
                    <div class="flex-1 bg-white rounded-2xl p-4 shadow-md border border-gray-100 flex flex-col gap-3">
                        <h3 class="text-lg font-jua text-pink-500 mb-1 text-center border-b pb-3 shrink-0">ë¬¸êµ¬ ì…ë ¥</h3>
                        
                        <div class="flex flex-col gap-2">
                            <textarea id="input-text-content" rows="2" placeholder="ë¬¸êµ¬ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ìµœëŒ€ 2ì¤„)" class="w-full p-2 border rounded-xl bg-gray-50 focus:outline-none focus:ring-2 focus:ring-pink-300 font-gothic text-sm resize-none"></textarea>
                            
                            <div class="flex gap-2">
                                <select id="font-selector" class="font-selector flex-1 bg-gray-50">
                                    <option value="Jua" selected>ì£¼ì•„ì²´</option>
                                    <option value="Nanum Gothic">ê¸°ë³¸ ê³ ë”•</option>
                                    <option value="Nanum Pen Script">ë‚˜ëˆ”íœ</option>
                                </select>
                                <button onclick="addTextItem()" class="bg-pink-500 text-white px-4 py-2 rounded-xl font-jua shadow-sm hover:bg-pink-600 active:scale-95 transition">ì¶”ê°€</button>
                            </div>
                        </div>

                        <div class="flex-1 flex flex-col overflow-hidden">
                            <label class="text-xs font-bold text-gray-400 mb-2">ê¸€ì ìƒ‰ìƒ</label>
                            <div id="text-color-dots" class="flex-1 overflow-y-auto hide-scrollbar grid grid-cols-4 gap-2 content-start justify-items-center p-1"></div>
                        </div>
                    </div>
                    <div class="flex-1 flex items-center justify-center bg-gray-200/40 rounded-2xl border-2 border-dashed border-gray-200 overflow-hidden p-3 relative">
                        <div class="preview-container">
                            <div class="canvas-wrapper">
                                <canvas id="bg-canvas-text" class="layer-canvas"></canvas>
                                <canvas id="text-canvas" class="layer-canvas"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="w-full flex gap-3 shrink-0 h-16">
                    <button onclick="showStep('step-decorate-sticker')" class="flex-1 bg-gray-200 text-gray-600 font-jua text-xl rounded-xl shadow transition">ì´ì „</button>
                    <button onclick="finishDecorate()" class="flex-[2] bg-indigo-600 text-white font-jua text-2xl rounded-xl shadow transition">ì™„ì„±í•˜ê¸°</button>
                </div>
            </section>

            <!-- 7ï¸âƒ£ Result Screen -->
            <section id="step-result" class="hidden flex flex-col items-center w-full h-full p-4 overflow-hidden">
                <h2 class="text-2xl font-jua text-indigo-600 mb-3">í–‰ë³µë„¤ì»· ì™„ì„±!</h2>
                <div class="flex-1 w-full flex items-center justify-center py-2 overflow-hidden mb-4">
                    <canvas id="print-canvas" class="h-full shadow-2xl rounded-sm"></canvas>
                    <!-- 4x6 ì¶œë ¥ìš© ìº”ë²„ìŠ¤ (ìˆ¨ê¹€) -->
                    <canvas id="print-canvas-4x6" class="hidden"></canvas>
                </div>
                
                <div class="w-full flex flex-col gap-3 shrink-0 px-2 max-w-[400px]">
                    <div class="flex gap-2 w-full">
                        <button onclick="downloadResult()" class="flex-1 bg-indigo-500 text-white font-jua text-lg py-3 rounded-xl shadow-lg active:scale-95 transition flex items-center justify-center gap-1">
                            <i data-lucide="download" class="w-5 h-5"></i> ì €ì¥ (2x6)
                        </button>
                        <button onclick="downloadPrintResult()" class="flex-1 bg-green-500 text-white font-jua text-lg py-3 rounded-xl shadow-lg active:scale-95 transition flex items-center justify-center gap-1">
                            <i data-lucide="printer" class="w-5 h-5"></i> ì¶œë ¥ìš© (4x6)
                        </button>
                    </div>
                    <div class="flex gap-3 h-14 w-full">
                        <button onclick="showStep('step-decorate-text')" class="flex-1 bg-gray-200 text-gray-600 font-jua text-lg rounded-xl shadow active:scale-95 transition">
                            ì´ì „ (ê¾¸ë¯¸ê¸°)
                        </button>
                        <button onclick="location.reload()" class="flex-1 bg-pink-500 text-white font-jua text-lg rounded-xl shadow active:scale-95 transition">
                            ì²˜ìŒìœ¼ë¡œ
                        </button>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
        let state = {
            photos: [],
            selectedIndices: [],
            frameStyle: '#ffffff',
            soundEnabled: true,
            isCapturing: false,
            audioCtx: null,
            todayStr: new Date().toLocaleDateString('ko-KR', { year: 'numeric', month: '2-digit', day: '2-digit' }),
            stickers: [], 
            texts: [],
            selectedItem: null,
            selectedType: null, 
            currentTextColor: '#000000',
            isDragging: false,
            isResizing: false,
            startX: 0,
            startY: 0,
            startDist: 0,
            startScale: 1,
            startFontSize: 40,
            version: 'V3.11'
        };

        const colors = [
            '#ffffff', '#f3f4f6', '#d1d5db', '#4b5563', '#1f2937', '#000000',
            '#FAD0C4', '#FFD1DC', '#FFABAB', '#FFC3A0', '#FF9AA2', '#FFB7B2',
            '#FFDAC1', '#FFFFD1', '#FFF5BA', '#F9F871', '#FFC75F', '#FFD8B1',
            '#B5EAD7', '#C7E9B0', '#E2F0CB', '#A8E6CF', '#DCEDC1', '#00C9A7',
            '#bae1ff', '#BAE1FF', '#C7CEEA', '#A2D2FF', '#00D2FC', '#4D8076'
        ];

        const textColorPalette = [
            '#000000', '#ffffff', '#4b5563', '#94a3b8',
            '#ef4444', '#f97316', '#facc15', '#22c55e', 
            '#10b981', '#06b6d4', '#3b82f6', '#6366f1', 
            '#8b5cf6', '#a855f7', '#d946ef', '#ec4899', 
            '#78350f', '#451a03', '#134e4a', '#1e1b4b',
            '#fca5a5', '#fef08a', '#bbf7d0', '#bfdbfe'
        ];

        const stickerList = [
            'â¤ï¸', 'ğŸ’–', 'âœ¨', 'â­', 'ğŸ€', 'ğŸŒ¸', 'ğŸŒˆ', 'ğŸ”¥', 'ğŸˆ', 'ğŸ‰',
            'ğŸ€', 'ğŸ‘‘', 'ğŸ§¸', 'ğŸ­', 'ğŸ“', 'ğŸ‘', 'ğŸ‹', 'ğŸ¥‘', 'ğŸ•', 'ğŸ¦',
            'ğŸ¶', 'ğŸ±', 'ğŸ°', 'ğŸ¼', 'ğŸ¦Š', 'ğŸ»', 'ğŸ£', 'ğŸ¦„', 'ğŸ',
            'ğŸ˜Š', 'ğŸ˜', 'ğŸ¥³', 'ğŸ˜', 'ğŸ¤©', 'ğŸ¥°', 'ğŸ˜œ', 'ğŸ‘»', 'ğŸ‘½', 'ğŸ‘¾',
            'ğŸ’¬', 'ğŸ’¡', 'ğŸµ', 'ğŸ¨', 'ğŸ“¸', 'ğŸ•¶ï¸', 'ğŸ’', 'ğŸ’', 'ğŸ‘Ÿ', 'ğŸ‘œ',
            'ğŸŒ»', 'ğŸ', 'ğŸŒ™', 'â˜ï¸', 'ğŸ’', 'ğŸ©', 'ğŸ”', 'ğŸŸ', 'ğŸ€', 'âš½'
        ];

        function showStep(stepId) {
            document.querySelectorAll('main > section').forEach(s => s.classList.add('hidden'));
            document.getElementById(stepId).classList.remove('hidden');
            lucide.createIcons();
            
            if(stepId === 'step-decorate-frame') drawFrameCanvas('editor-canvas');
            if(stepId === 'step-decorate-sticker') {
                drawFrameCanvas('bg-canvas-sticker');
                renderStickerGrid();
                initInteractionEvents('sticker-canvas', 'sticker');
                renderStickers();
            }
            if(stepId === 'step-decorate-text') {
                drawBaseWithStickers('bg-canvas-text');
                renderTexts();
                initTextColorPalette();
                initInteractionEvents('text-canvas', 'text');
            }
        }

        // --- Audio Utils ---
        function initAudio() { if (!state.audioCtx) state.audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
        function playBeep() {
            if (!state.soundEnabled) return; initAudio();
            const osc = state.audioCtx.createOscillator(); const gain = state.audioCtx.createGain();
            osc.connect(gain); gain.connect(state.audioCtx.destination);
            osc.frequency.setValueAtTime(880, state.audioCtx.currentTime);
            gain.gain.setValueAtTime(0, state.audioCtx.currentTime);
            gain.gain.linearRampToValueAtTime(0.1, state.audioCtx.currentTime + 0.01);
            gain.gain.exponentialRampToValueAtTime(0.01, state.audioCtx.currentTime + 0.1);
            osc.start(); osc.stop(state.audioCtx.currentTime + 0.1);
        }
        function playDingDong() {
            if (!state.soundEnabled) return; initAudio();
            const playNote = (freq, start, duration) => {
                const osc = state.audioCtx.createOscillator(); const gain = state.audioCtx.createGain();
                osc.connect(gain); gain.connect(state.audioCtx.destination);
                osc.type = 'triangle'; osc.frequency.setValueAtTime(freq, state.audioCtx.currentTime + start);
                gain.gain.setValueAtTime(0, state.audioCtx.currentTime + start);
                gain.gain.linearRampToValueAtTime(0.2, state.audioCtx.currentTime + start + 0.05);
                gain.gain.exponentialRampToValueAtTime(0.01, state.audioCtx.currentTime + start + duration);
                osc.start(state.audioCtx.currentTime + start); osc.stop(state.audioCtx.currentTime + start + duration);
            };
            playNote(659.25, 0, 0.4); playNote(523.25, 0.25, 0.5);
        }
        function toggleSound() {
            state.soundEnabled = !state.soundEnabled;
            const bg = document.getElementById('toggle-bg');
            const circle = document.getElementById('toggle-circle');
            const icon = document.getElementById('sound-icon');
            const labelOff = document.getElementById('label-off-ext');
            const labelOn = document.getElementById('label-on-ext');

            if(state.soundEnabled) {
                bg.classList.replace('bg-gray-300', 'bg-pink-500');
                circle.classList.replace('translate-x-0', 'translate-x-7');
                icon.setAttribute('data-lucide', 'volume-2');
                labelOn.classList.replace('text-gray-400', 'text-pink-500');
                labelOff.classList.replace('text-pink-500', 'text-gray-400');
            } else {
                bg.classList.replace('bg-pink-500', 'bg-gray-300');
                circle.classList.replace('translate-x-7', 'translate-x-0');
                icon.setAttribute('data-lucide', 'volume-x');
                labelOff.classList.replace('text-gray-400', 'text-pink-500');
                labelOn.classList.replace('text-pink-500', 'text-gray-400');
            }
            lucide.createIcons();
        }

        // --- Camera Logic ---
        async function startCamera() {
            state.isCapturing = true; state.photos = [];
            showStep('step-camera');
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
                document.getElementById('video-feed').srcObject = stream;
                runAutoCapture();
            } catch (err) { alert("ì¹´ë©”ë¼ ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”."); stopCameraAndGoHome(); }
        }
        function stopCameraAndGoHome() {
            state.isCapturing = false;
            const video = document.getElementById('video-feed');
            if(video.srcObject) video.srcObject.getTracks().forEach(t => t.stop());
            showStep('step-start');
        }
        function restartCamera() { state.selectedIndices = []; startCamera(); }
        async function runAutoCapture() {
            const video = document.getElementById('video-feed');
            const canvas = document.getElementById('capture-canvas');
            const overlay = document.getElementById('countdown-overlay');
            const countdownText = document.getElementById('countdown-text');
            const ctx = canvas.getContext('2d');
            const container = document.getElementById('camera-container');
            for(let i=1; i<=6; i++) {
                if(!state.isCapturing) return;
                document.getElementById('shot-count').innerText = i;
                overlay.classList.remove('hidden');
                for(let c=3; c>=1; c--) {
                    if(!state.isCapturing) return;
                    countdownText.innerText = c; playBeep();
                    await new Promise(r => setTimeout(r, 1000));
                }
                overlay.classList.add('hidden');
                container.classList.add('flash-effect'); playDingDong();
                canvas.width = video.videoWidth; canvas.height = video.videoHeight;
                ctx.translate(canvas.width, 0); ctx.scale(-1, 1);
                ctx.drawImage(video, 0, 0);
                state.photos.push(canvas.toDataURL('image/jpeg'));
                await new Promise(r => setTimeout(r, 500));
                container.classList.remove('flash-effect');
            }
            if(video.srcObject) video.srcObject.getTracks().forEach(t => t.stop());
            renderPhotoGrid(); showStep('step-select');
        }

        // --- Selection Logic ---
        function renderPhotoGrid() {
            const grid = document.getElementById('photo-grid'); grid.innerHTML = '';
            state.photos.forEach((src, idx) => {
                const div = document.createElement('div');
                div.className = 'relative photo-card bg-white rounded-xl overflow-hidden shadow-md cursor-pointer aspect-square border-2 border-transparent transition-all';
                div.onclick = () => togglePhotoSelection(idx);
                div.innerHTML = `<img src="${src}" class="w-full h-full object-cover">`;
                grid.appendChild(div);
            });
            updateSelectionUI();
        }
        function togglePhotoSelection(idx) {
            const sIdx = state.selectedIndices.indexOf(idx);
            if(sIdx > -1) state.selectedIndices.splice(sIdx, 1);
            else if(state.selectedIndices.length < 4) state.selectedIndices.push(idx);
            updateSelectionUI();
        }
        function updateSelectionUI() {
            document.querySelectorAll('.photo-card').forEach((card, idx) => {
                card.classList.remove('selected');
                const existingNum = card.querySelector('.photo-number');
                if(existingNum) existingNum.remove();
                const numIdx = state.selectedIndices.indexOf(idx);
                if(numIdx > -1) {
                    card.classList.add('selected');
                    const span = document.createElement('span');
                    span.className = 'photo-number'; span.innerText = numIdx + 1;
                    card.appendChild(span);
                }
            });
            document.getElementById('selected-count').innerText = state.selectedIndices.length;
            const btn = document.getElementById('btn-confirm-select');
            btn.disabled = state.selectedIndices.length !== 4;
            btn.className = `flex-[2] font-jua rounded-2xl shadow-md transition text-2xl ${state.selectedIndices.length === 4 ? 'bg-pink-500 text-white' : 'bg-gray-300 text-white'}`;
        }

        // --- Decorate: Frame ---
        function goToFrameStep() { initColorPalette(); showStep('step-decorate-frame'); }
        function initColorPalette() {
            const grid = document.getElementById('color-dots-grid');
            grid.innerHTML = '';
            colors.forEach((color) => {
                const dot = document.createElement('div');
                dot.className = `color-dot ${state.frameStyle === color ? 'active' : ''}`;
                dot.style.backgroundColor = color;
                dot.onclick = () => {
                    state.frameStyle = color;
                    document.querySelectorAll('.color-dot').forEach(d => d.classList.remove('active'));
                    dot.classList.add('active');
                    drawFrameCanvas('editor-canvas');
                };
                grid.appendChild(dot);
            });
        }

        async function drawFrameCanvas(canvasId) {
            const canvas = (typeof canvasId === 'string') ? document.getElementById(canvasId) : canvasId;
            const ctx = canvas.getContext('2d');
            canvas.width = 600; canvas.height = 1800;
            
            ctx.fillStyle = state.frameStyle;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            const isDark = ['#000000', '#1f2937', '#4b5563'].includes(state.frameStyle);
            ctx.fillStyle = isDark ? '#ffffff' : '#ec4899';
            
            // ìˆ˜ì •: ê¸€ì ì†ì„±ì—ì„œ bold ì œê±° ë° ìê°„(letterSpacing) ì¶”ê°€
            ctx.font = '68px Jua'; 
            ctx.textAlign = 'center'; 
            ctx.textBaseline = 'top';
            ctx.letterSpacing = '20px'; // ê¸€ì ê°„ê²© ë„“í˜
            ctx.fillText('í–‰ë³µë„¤ì»·', canvas.width / 2, 60);
            ctx.letterSpacing = '0px'; // ì´í›„ í…ìŠ¤íŠ¸ë¥¼ ìœ„í•´ ìê°„ ì´ˆê¸°í™”
            
            const margin = 90; const imgW = canvas.width - (margin * 2); 
            const imgH = imgW * 0.72; const startY = 180; const gap = 30; 
            
            for (let i = 0; i < 4; i++) {
                const pIdx = state.selectedIndices[i];
                if (pIdx !== undefined) {
                    const img = new Image(); img.src = state.photos[pIdx];
                    await new Promise(r => { 
                        img.onload = () => { 
                            ctx.drawImage(img, margin, startY + (i * (imgH + gap)), imgW, imgH); 
                            r(); 
                        }; 
                    });
                }
            }
            
            ctx.fillStyle = isDark ? '#aaaaaa' : '#555555'; 
            ctx.font = '30px Noto Sans KR'; ctx.textAlign = 'center'; ctx.textBaseline = 'bottom';
            ctx.fillText(state.todayStr, canvas.width / 2, canvas.height - 60);
        }

        // --- Decorate: Sticker ---
        function goToStickerStep() {
            const sCanvas = document.getElementById('sticker-canvas');
            sCanvas.width = 600; sCanvas.height = 1800;
            showStep('step-decorate-sticker');
        }

        function renderStickerGrid() {
            const grid = document.getElementById('sticker-grid');
            grid.innerHTML = '';
            stickerList.forEach(emoji => {
                const item = document.createElement('div');
                item.className = 'sticker-item';
                item.innerText = emoji;
                item.onclick = () => addSticker(emoji);
                grid.appendChild(item);
            });
        }

        function addSticker(emoji) {
            state.stickers.push({
                text: emoji,
                x: 300, y: 900,
                scale: 2.0,
                id: Date.now()
            });
            renderStickers();
        }

        function renderStickers() {
            const canvas = document.getElementById('sticker-canvas');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0,0,canvas.width,canvas.height);

            state.stickers.forEach(s => {
                ctx.save();
                ctx.translate(s.x, s.y);
                ctx.scale(s.scale, s.scale); // ì»¨í…ìŠ¤íŠ¸ ìŠ¤ì¼€ì¼ ì‚¬ìš©
                
                // í…ìŠ¤íŠ¸ ê·¸ë¦¬ê¸° (ë¡œì»¬ ì¢Œí‘œê³„ 0,0)
                ctx.font = '50px serif';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(s.text, 0, 0);

                // ì„ íƒëœ ê²½ìš° í…Œë‘ë¦¬ì™€ ë²„íŠ¼ ê·¸ë¦¬ê¸°
                if(state.selectedItem && state.selectedItem.id === s.id && state.selectedType === 'sticker') {
                    // í…Œë‘ë¦¬ (ë¡œì»¬ ì¢Œí‘œ)
                    const halfSize = 30;
                    ctx.strokeStyle = '#ec4899';
                    ctx.lineWidth = 2 / s.scale;
                    ctx.strokeRect(-halfSize, -halfSize, halfSize*2, halfSize*2);
                    
                    // ë²„íŠ¼ í¬ê¸°ë¥¼ í‚¤ì›€ (24 / s.scale) - ê¸°ì¡´ ëŒ€ë¹„ 2ë°° í™•ëŒ€ íš¨ê³¼
                    const handleSize = 24 / s.scale; 

                    // 1. ì‚­ì œ ë²„íŠ¼ (ìš°ìƒë‹¨)
                    ctx.fillStyle = '#ef4444'; 
                    ctx.beginPath();
                    ctx.arc(halfSize, -halfSize, handleSize, 0, Math.PI * 2);
                    ctx.fill();
                    // X ì•„ì´ì½˜
                    ctx.strokeStyle = 'white';
                    ctx.lineWidth = 3 / s.scale;
                    ctx.beginPath();
                    ctx.moveTo(halfSize - handleSize/2, -halfSize - handleSize/2);
                    ctx.lineTo(halfSize + handleSize/2, -halfSize + handleSize/2);
                    ctx.moveTo(halfSize + handleSize/2, -halfSize - handleSize/2);
                    ctx.lineTo(halfSize - handleSize/2, -halfSize + handleSize/2);
                    ctx.stroke();

                    // 2. ë¦¬ì‚¬ì´ì¦ˆ ë²„íŠ¼ (ìš°í•˜ë‹¨)
                    ctx.fillStyle = '#3b82f6'; 
                    ctx.beginPath();
                    ctx.arc(halfSize, halfSize, handleSize, 0, Math.PI * 2);
                    ctx.fill();
                    // ëŒ€ê°ì„  í™”ì‚´í‘œ ì•„ì´ì½˜
                    ctx.strokeStyle = 'white';
                    ctx.beginPath();
                    ctx.moveTo(halfSize - handleSize/2, halfSize - handleSize/2); // ì¢Œìƒ
                    ctx.lineTo(halfSize + handleSize/2, halfSize + handleSize/2); // ìš°í•˜
                    // í™”ì‚´í‘œ ë¨¸ë¦¬ (ê°„ë‹¨íˆ ì„ ìœ¼ë¡œ í‘œí˜„)
                    ctx.moveTo(halfSize + handleSize/2, halfSize + handleSize/2);
                    ctx.lineTo(halfSize + handleSize/2, halfSize); 
                    ctx.moveTo(halfSize + handleSize/2, halfSize + handleSize/2);
                    ctx.lineTo(halfSize, halfSize + handleSize/2);
                    ctx.moveTo(halfSize - handleSize/2, halfSize - handleSize/2);
                    ctx.lineTo(halfSize - handleSize/2, halfSize);
                    ctx.moveTo(halfSize - handleSize/2, halfSize - handleSize/2);
                    ctx.lineTo(halfSize, halfSize - handleSize/2);
                    ctx.stroke();
                }
                ctx.restore();
            });
        }

        // --- Decorate: Text ---
        function goToTextStep() {
            const tCanvas = document.getElementById('text-canvas');
            tCanvas.width = 600; tCanvas.height = 1800;
            showStep('step-decorate-text');
        }

        async function drawBaseWithStickers(canvasId) {
            const canvas = document.getElementById(canvasId);
            const ctx = canvas.getContext('2d');
            canvas.width = 600; canvas.height = 1800;

            // 1. Frame & Photos
            await drawFrameCanvas(canvas);

            // 2. Stickers
            state.stickers.forEach(s => {
                ctx.save();
                ctx.translate(s.x, s.y);
                ctx.scale(s.scale, s.scale);
                ctx.font = '50px serif';
                ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                ctx.fillText(s.text, 0, 0);
                ctx.restore();
            });
        }

        function initTextColorPalette() {
            const grid = document.getElementById('text-color-dots');
            grid.innerHTML = '';
            textColorPalette.forEach(color => {
                const dot = document.createElement('div');
                dot.className = `color-dot ${state.currentTextColor === color ? 'active' : ''}`;
                dot.style.backgroundColor = color;
                dot.onclick = () => {
                    state.currentTextColor = color;
                    document.querySelectorAll('#text-color-dots .color-dot').forEach(d => d.classList.remove('active'));
                    dot.classList.add('active');
                };
                grid.appendChild(dot);
            });
        }

        function addTextItem() {
            const content = document.getElementById('input-text-content').value;
            const font = document.getElementById('font-selector').value;
            if(!content.trim()) return alert('ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');

            // ë§ˆì§€ë§‰ ì‚¬ì§„ ì•„ë˜ì™€ ë‚ ì§œ ì‚¬ì´ì˜ ì—¬ë°± ì¤‘ì•™ ì¢Œí‘œ (ì•½ 1610)
            const defaultY = 1610; 

            state.texts.push({
                content: content,
                fontFamily: font,
                color: state.currentTextColor,
                x: 300, y: defaultY,
                fontSize: 40,
                id: Date.now()
            });
            document.getElementById('input-text-content').value = '';
            renderTexts();
        }

        function renderTexts() {
            const canvas = document.getElementById('text-canvas');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0,0,canvas.width,canvas.height);

            state.texts.forEach(t => {
                ctx.save();
                ctx.translate(t.x, t.y);
                ctx.fillStyle = t.color;
                ctx.font = `${t.fontSize}px "${t.fontFamily}"`;
                ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                
                const lines = t.content.split('\n');
                const lineHeight = t.fontSize * 1.2;
                lines.forEach((line, i) => {
                    ctx.fillText(line, 0, (i - (lines.length-1)/2) * lineHeight);
                });

                if(state.selectedItem && state.selectedItem.id === t.id && state.selectedType === 'text') {
                    // í…ìŠ¤íŠ¸ í¬ê¸° ê³„ì‚°
                    let maxWidth = 0;
                    lines.forEach(line => {
                         const w = ctx.measureText(line).width;
                         if(w > maxWidth) maxWidth = w;
                    });
                    const totalHeight = lines.length * lineHeight;
                    const halfW = (maxWidth + 30) / 2; 
                    const halfH = (totalHeight + 30) / 2;

                    // ìƒíƒœì— ì €ì¥ (íˆíŠ¸ í…ŒìŠ¤íŠ¸ìš©)
                    t._halfW = halfW;
                    t._halfH = halfH;

                    // í…Œë‘ë¦¬
                    ctx.strokeStyle = '#ec4899';
                    ctx.lineWidth = 2;
                    ctx.strokeRect(-halfW, -halfH, halfW*2, halfH*2);
                    
                    // ë²„íŠ¼ í¬ê¸°ë¥¼ í‚¤ì›€ (20px)
                    const handleSize = 20;

                    // 1. ì‚­ì œ ë²„íŠ¼ (ìš°ìƒë‹¨)
                    ctx.fillStyle = '#ef4444';
                    ctx.beginPath();
                    ctx.arc(halfW, -halfH, handleSize, 0, Math.PI * 2);
                    ctx.fill();
                    // X
                    ctx.strokeStyle = 'white';
                    ctx.lineWidth = 3;
                    ctx.beginPath();
                    ctx.moveTo(halfW - 8, -halfH - 8); ctx.lineTo(halfW + 8, -halfH + 8);
                    ctx.moveTo(halfW + 8, -halfH - 8); ctx.lineTo(halfW - 8, -halfH + 8);
                    ctx.stroke();

                    // 2. ë¦¬ì‚¬ì´ì¦ˆ ë²„íŠ¼ (ìš°í•˜ë‹¨)
                    ctx.fillStyle = '#3b82f6';
                    ctx.beginPath();
                    ctx.arc(halfW, halfH, handleSize, 0, Math.PI * 2);
                    ctx.fill();
                    // í™”ì‚´í‘œ
                    ctx.strokeStyle = 'white';
                    ctx.beginPath();
                    ctx.moveTo(halfW - 8, halfH - 8); ctx.lineTo(halfW + 8, halfH + 8);
                    ctx.moveTo(halfW + 8, halfH + 8); ctx.lineTo(halfW + 8, halfH);
                    ctx.moveTo(halfW + 8, halfH + 8); ctx.lineTo(halfW, halfH + 8);
                    ctx.moveTo(halfW - 8, halfH - 8); ctx.lineTo(halfW - 8, halfH);
                    ctx.moveTo(halfW - 8, halfH - 8); ctx.lineTo(halfW, halfH - 8);
                    ctx.stroke();
                } else {
                    // ì„ íƒë˜ì§€ ì•Šì•˜ì„ ë•Œë„ ëŒ€ëµì  í¬ê¸° ì €ì¥ í•„ìš”
                    let maxWidth = 0;
                    lines.forEach(line => { const w = ctx.measureText(line).width; if(w > maxWidth) maxWidth = w; });
                    t._halfW = (maxWidth + 30) / 2;
                    t._halfH = (lines.length * lineHeight + 30) / 2;
                }
                ctx.restore();
            });
        }

        // --- Interaction (Drag & Drop & Resize & Delete) ---
        function initInteractionEvents(canvasId, type) {
            const canvas = document.getElementById(canvasId);
            
            const getCanvasXY = (clientX, clientY) => {
                const rect = canvas.getBoundingClientRect();
                const scaleX = canvas.width / rect.width;
                const scaleY = canvas.height / rect.height;
                return {
                    x: (clientX - rect.left) * scaleX,
                    y: (clientY - rect.top) * scaleY
                };
            };

            const handleStart = (clientX, clientY) => {
                const {x, y} = getCanvasXY(clientX, clientY);

                // 1. í˜„ì¬ ì„ íƒëœ ì•„ì´í…œì˜ ì»¨íŠ¸ë¡¤ ë²„íŠ¼(ì‚­ì œ/ë¦¬ì‚¬ì´ì¦ˆ) ì²´í¬
                if(state.selectedItem && state.selectedType === type) {
                    const item = state.selectedItem;
                    let halfW, halfH;
                    
                    if (type === 'sticker') {
                        halfW = 30 * item.scale;
                        halfH = 30 * item.scale;
                    } else {
                        halfW = item._halfW || 50;
                        halfH = item._halfH || 20;
                    }

                    // ì‚­ì œ ë²„íŠ¼ (ìš°ìƒë‹¨) ë°˜ê²½ ì²´í¬ (í„°ì¹˜ ì˜ì—­ ì•½ 40pxë¡œ í™•ëŒ€)
                    const delX = item.x + halfW;
                    const delY = item.y - halfH;
                    if (Math.hypot(x - delX, y - delY) < 40) {
                        if(type === 'sticker') state.stickers = state.stickers.filter(s => s.id !== item.id);
                        else state.texts = state.texts.filter(t => t.id !== item.id);
                        
                        state.selectedItem = null;
                        if(type === 'sticker') renderStickers(); else renderTexts();
                        return;
                    }

                    // ë¦¬ì‚¬ì´ì¦ˆ ë²„íŠ¼ (ìš°í•˜ë‹¨) ì²´í¬ (í„°ì¹˜ ì˜ì—­ ì•½ 40pxë¡œ í™•ëŒ€)
                    const resX = item.x + halfW;
                    const resY = item.y + halfH;
                    if (Math.hypot(x - resX, y - resY) < 40) {
                        state.isResizing = true;
                        state.startDist = Math.hypot(x - item.x, y - item.y); // ì¤‘ì‹¬-í„°ì¹˜ ê±°ë¦¬
                        state.startScale = item.scale || 1;
                        state.startFontSize = item.fontSize || 40;
                        return;
                    }
                }

                // 2. ì•„ì´í…œ ì„ íƒ (ì—­ìˆœ)
                let items = type === 'sticker' ? state.stickers : state.texts;
                for(let i = items.length - 1; i >= 0; i--) {
                    const item = items[i];
                    let halfW, halfH;
                    if(type === 'sticker') { halfW = 30 * item.scale; halfH = 30 * item.scale; }
                    else { halfW = item._halfW || 50; halfH = item._halfH || 20; }

                    // ë‹¨ìˆœ ë°•ìŠ¤ íˆíŠ¸ í…ŒìŠ¤íŠ¸
                    if (x >= item.x - halfW && x <= item.x + halfW &&
                        y >= item.y - halfH && y <= item.y + halfH) {
                        
                        state.selectedItem = item;
                        state.selectedType = type;
                        state.isDragging = true;
                        state.startX = x;
                        state.startY = y;
                        if(type === 'sticker') renderStickers(); else renderTexts();
                        return;
                    }
                }

                // ë¹ˆ ê³µê°„ -> ì„ íƒ í•´ì œ
                state.selectedItem = null;
                if(type === 'sticker') renderStickers(); else renderTexts();
            };

            const handleMove = (clientX, clientY) => {
                const {x, y} = getCanvasXY(clientX, clientY);

                if (state.isResizing && state.selectedItem) {
                    const item = state.selectedItem;
                    const currentDist = Math.hypot(x - item.x, y - item.y);
                    const ratio = currentDist / state.startDist;

                    if (type === 'sticker') {
                        let newScale = state.startScale * ratio;
                        if (newScale < 0.5) newScale = 0.5; // ìµœì†Œ í¬ê¸° ì œí•œ
                        if (newScale > 5.0) newScale = 5.0; // ìµœëŒ€ í¬ê¸° ì œí•œ
                        item.scale = newScale;
                        renderStickers();
                    } else {
                        let newSize = state.startFontSize * ratio;
                        if (newSize < 10) newSize = 10;
                        if (newSize > 120) newSize = 120;
                        item.fontSize = newSize;
                        renderTexts();
                    }
                    return;
                }

                if (state.isDragging && state.selectedItem) {
                    state.selectedItem.x = x;
                    state.selectedItem.y = y;
                    if(type === 'sticker') renderStickers(); else renderTexts();
                }
            };

            const handleEnd = () => {
                state.isDragging = false;
                state.isResizing = false;
            };

            // Double click to edit text
            canvas.ondblclick = (e) => {
                if (type !== 'text') return;
                
                const {x, y} = getCanvasXY(e.clientX, e.clientY);
                
                // Check if a text item is clicked
                // Reverse order
                 for(let i = state.texts.length - 1; i >= 0; i--) {
                    const item = state.texts[i];
                    const halfW = item._halfW || 50; 
                    const halfH = item._halfH || 20;

                    if (x >= item.x - halfW && x <= item.x + halfW &&
                        y >= item.y - halfH && y <= item.y + halfH) {
                        
                        const newContent = prompt("ë¬¸êµ¬ë¥¼ ìˆ˜ì •í•˜ì„¸ìš”:", item.content);
                        if (newContent !== null) {
                            item.content = newContent;
                            renderTexts();
                        }
                        return;
                    }
                }
            };

            // Touch events
            canvas.ontouchstart = (e) => { e.preventDefault(); handleStart(e.touches[0].clientX, e.touches[0].clientY); };
            canvas.ontouchmove = (e) => { e.preventDefault(); handleMove(e.touches[0].clientX, e.touches[0].clientY); };
            canvas.ontouchend = (e) => { e.preventDefault(); handleEnd(); };

            // Mouse events
            canvas.onmousedown = (e) => handleStart(e.clientX, e.clientY);
            canvas.onmousemove = (e) => handleMove(e.clientX, e.clientY);
            canvas.onmouseup = () => handleEnd();
            canvas.onmouseleave = () => handleEnd();
        }

        // --- Result & Download ---
        async function finishDecorate() {
            state.selectedItem = null; // ì„ íƒ í•´ì œ
            const canvas = document.getElementById('print-canvas');
            const ctx = canvas.getContext('2d');
            
            // 2ì¸ì¹˜ x 6ì¸ì¹˜ (300 DPI ê¸°ì¤€) = 600px x 1800px
            canvas.width = 600; 
            canvas.height = 1800;

            // 1. Frame & Photos (Async)
            await drawFrameCanvas(canvas);

            // 2. Stickers
            state.stickers.forEach(s => {
                ctx.save();
                ctx.translate(s.x, s.y);
                ctx.scale(s.scale, s.scale);
                ctx.font = '50px serif';
                ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                ctx.fillText(s.text, 0, 0);
                ctx.restore();
            });

            // 3. Texts
            state.texts.forEach(t => {
                ctx.save();
                ctx.translate(t.x, t.y);
                ctx.fillStyle = t.color;
                ctx.font = `${t.fontSize}px "${t.fontFamily}"`;
                ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                const lines = t.content.split('\n');
                lines.forEach((line, i) => {
                    ctx.fillText(line, 0, (i - (lines.length-1)/2) * (t.fontSize * 1.2));
                });
                ctx.restore();
            });

            // 4. Create 4x6 print version (Horizontal 2-up)
            const printCanvas = document.getElementById('print-canvas-4x6');
            const pCtx = printCanvas.getContext('2d');
            // 4ì¸ì¹˜ x 6ì¸ì¹˜ (300 DPI) = 1200px x 1800px
            printCanvas.width = 1200;
            printCanvas.height = 1800;
            
            pCtx.fillStyle = '#ffffff';
            pCtx.fillRect(0, 0, 1200, 1800);
            
            // Draw original strip twice
            pCtx.drawImage(canvas, 0, 0);
            pCtx.drawImage(canvas, 600, 0);

            showStep('step-result');
        }

        function getTimestamp() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            return `${year}${month}${day}_${hours}${minutes}${seconds}`;
        }

        function downloadResult() {
            const canvas = document.getElementById('print-canvas');
            const link = document.createElement('a');
            link.download = `í–‰ë³µë„¤ì»·_${getTimestamp()}.jpg`;
            link.href = canvas.toDataURL('image/jpeg', 1.0); 
            link.click();
        }

        function downloadPrintResult() {
            const canvas = document.getElementById('print-canvas-4x6');
            const link = document.createElement('a');
            link.download = `í–‰ë³µë„¤ì»·_ì¶œë ¥ìš©_${getTimestamp()}.jpg`;
            link.href = canvas.toDataURL('image/jpeg', 1.0); 
            link.click();
        }

        // Init
        lucide.createIcons();
    </script>
</body>
</html>